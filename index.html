<!DOCTYPE html>
<html>
<head>
    <title>Factory idle</title>

    <meta charset="utf-8"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-width"/>
    
    <!-- Disable caching for development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link href="main.css" type="text/css" rel="stylesheet"/>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


</head>
<body>
<div class="main mainWithAdd" id="main">
    <div style="float:left; width:728px;height:90px"></div>
    <div style="float:right; width:320px;height:100px"></div>
    <br style="clear:both;" />
    <div id="gameArea">
        <div class="loadingBg" id="initialLoaderBg"></div>
        <div class="loading" id="initialLoader" style="width:500px;">
            <center>
                <img src="img/loader.gif" class="icon"/><br/>
                <span class="message" id="loadingMessage">Loading... hold on...</span>
            </center>
        </div>
        <script type="text/javascript">
            var GAME_LOADED = false;
            
            // Wait for DOM to be ready before accessing elements
            function initializeLoader() {
                var initialLoader = document.getElementById("initialLoader");
                var loadingMessage = document.getElementById("loadingMessage");
                
                if (initialLoader) {
                    initialLoader.style.left = (window.innerWidth / 2 - 250) + "px";
                }
                
                // Setup custom error handler to detect loading errors
                var oldErrorHandler = window.onerror;
                window.onerror = function (msg, url, lineNo, columnNo, error) {
                    GAME_LOADED = true;
                    if (loadingMessage) {
                        loadingMessage.innerHTML = "<b class='red'>Error loading the game.</b><br /> Please try again and if still happens, send this to developer: <br />" +
                            "<br />" +
                            "<textarea style='width:470px; height:65px; color:white; background-color:black;'>" +
                            "" + msg + "\n" +
                            "" + url + "\n" +
                            "line:" + lineNo + " col: " + columnNo + "\n" +
                            "</textarea>";
                    }
                };

                setTimeout(function () {
                    if (!GAME_LOADED && loadingMessage) {
                        loadingMessage.innerHTML = "This is taking way longer than it should. <br /> " +
                            "Check: <br /> " +
                            "* Try to refresh. <br /> " +
                            "* Internet connection and it's speed. <br /> " +
                            "* Make sure you don't have ancient brower.<br />" +
                            "* Check developer console to see errors and report these to developer.";
                    }
                }, 30000);
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeLoader);
            } else {
                initializeLoader();
            }
        </script>
        
        <!-- Load RequireJS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
        
        <!-- Load jQuery -->
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        
        <!-- Load PlayFab SDK -->
        <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
        
        <script>
            // Wait for RequireJS to be available
            window.addEventListener('load', function() {
                console.log("Page loaded, configuring RequireJS...");
                
                // Configure RequireJS
                requirejs.config({
                    baseUrl: "js",
                    urlArgs: "bust=" + new Date().getTime(),
                    packages: [],
                    paths: {
                        template: "../template",
                        text: "lib/text",
                        handlebars: "../node_modules/handlebars/dist/handlebars.min",
                        templates: "templates",
                        kongregateApi: "https://cdn1.kongregate.com/javascripts/kongregate_api"
                    }
                });

                // Add string prototype extensions
                String.prototype.lcFirst = function() {
                    return this.charAt(0).toLowerCase() + this.slice(1);
                };
                
                String.prototype.ucFirst = function() {
                    return this.charAt(0).toUpperCase() + this.slice(1);
                };

                // Check browser support
                function isBrowserSupported() {
                    var canvas = document.createElement('canvas');
                    return !(!canvas.getContext || !canvas.getContext('2d'));
                }

                // Initialize the game
                console.log("Loading Main module...");
                requirejs([
                    "Main"
                ], function(Main) {
                    console.log("Main module loaded successfully:", Main);
                    
                    // Check browser support
                    if (isBrowserSupported()) {
                        // Create and initialize main instance
                        var MainInstance = new Main();
                        MainInstance.init(false, function() {
                            // Hide loading message and show game area
                            GAME_LOADED = true;
                            var initialLoader = document.getElementById("initialLoader");
                            var initialLoaderBg = document.getElementById("initialLoaderBg");
                            
                            if (initialLoader) {
                                initialLoader.style.display = "none";
                            }
                            if (initialLoaderBg) {
                                initialLoaderBg.style.display = "none";
                            }
                            console.log("Game initialized successfully!");
                        });
                    } else {
                        // Show browser not supported message
                        GAME_LOADED = true;
                        var loadingMessage = document.getElementById("loadingMessage");
                        if (loadingMessage) {
                            loadingMessage.innerHTML = 
                                "Unfortunately <b class='red'>your browser seems to be old</b> and does not support necessary elements (canvas) for this game to run. Please update your browser!";
                        }
                    }
                }, function(error) {
                    console.error("Failed to load Main module:", error);
                    var loadingMessage = document.getElementById("loadingMessage");
                    if (loadingMessage) {
                        loadingMessage.innerHTML = 
                            "<b class='red'>Failed to load game modules.</b><br />Check console for details.";
                    }
                });
            });
        </script>
    </div>
</div>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-99NCL5FCCC"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-99NCL5FCCC');
    gtag('set', 'page', '/');
    gtag('send', 'pageview');
    setInterval(function () {
        gtag('send', 'pageview');
    }, 1000 * 60 * 3);
</script>

<script>
    document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
    }, false);
</script>

<!-- Commented out for local development - uncomment for production -->
<!-- <script src="httpMigrate.js" type="text/javascript"></script> -->
<!-- <script type="text/javascript">httpMigration().inIndexFile()</script> -->

</body>
</html>
